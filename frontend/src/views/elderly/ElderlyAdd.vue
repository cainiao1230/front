<template>
  <div class="elderly-add-page">







































































































































































































































































































































































































**è”ç³»äºº**: å‰ç«¯å¼€å‘ï¼ˆéœ€è¦æ—¶æ²Ÿé€šå­—æ®µæ ¼å¼ï¼‰**æœ€åæ›´æ–°**: 2026-01-24  ---3. **ç­”è¾©å‰**: æ‰€æœ‰æ¼”ç¤ºæ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œæ¥å£å“åº”æ­£å¸¸2. **ä»Šå¤©å®Œæˆ**: åºŠä½æ–°å¢/æ›´æ–°æ¥å£ + ä»Šæ—¥ä»»åŠ¡æ¥å£1. **ç«‹å³åš**: æ¥¼å±‚ç»Ÿè®¡æ¥å£ + åºŠä½æ•°æ®å‡†å¤‡**ä¼˜å…ˆçº§æ€»ç»“**:---- åç«¯è¿”å›: ä¿æŒä¸€è‡´ï¼Œå»ºè®®ç”¨ ISO 8601 æ ¼å¼- å‰ç«¯å‘é€: `YYYY-MM-DD` æˆ– `YYYY-MM-DDTHH:mm:ss`### 3. æ—¥æœŸæ—¶é—´æ ¼å¼å‰ç«¯å‘é€è¯·æ±‚æ—¶å¸¦ `Authorization: Bearer {token}` å¤´ï¼Œåç«¯éœ€è§£æéªŒè¯ã€‚### 2. Token éªŒè¯```CORS(app, origins=['http://localhost:5173'])from flask_cors import CORS```pythonç¡®ä¿åç«¯å…è®¸å‰ç«¯åŸŸåè·¨åŸŸè®¿é—®ï¼š### 1. CORS é…ç½®## ğŸ“ å‰åç«¯è”è°ƒè¦ç‚¹---- 422: å‚æ•°æ ¼å¼é”™è¯¯- 409: çŠ¶æ€å†²çªï¼ˆå¦‚åºŠä½å·²è¢«å ç”¨ï¼‰- 404: èµ„æºä¸å­˜åœ¨- 400: å‚æ•°æ ¡éªŒå¤±è´¥ï¼ˆå¦‚åºŠä½ç¼–å·é‡å¤ï¼‰### é”™è¯¯å¤„ç†- åˆ†é¡µæ¥å£åšå¥½ç´¢å¼•ä¼˜åŒ–- ç¡®ä¿æ‰€æœ‰æ¥å£å“åº”æ—¶é—´ < 500ms### æ¥å£å“åº”é€Ÿåº¦3. **ä»»åŠ¡æ•°æ®**: ä»Šæ—¥ä»»åŠ¡5ä¸ªï¼ˆ2ä¸ªå®Œæˆã€2ä¸ªè¿›è¡Œä¸­ã€1ä¸ªå¾…å¼€å§‹ï¼‰2. **è€äººæ•°æ®**: 3ä¸ª pending ç”¨äºæ¼”ç¤ºå®¡æ‰¹ï¼Œ10ä¸ª in ç”¨äºæ¼”ç¤ºæŠ¤ç†1. **åºŠä½æ•°æ®**: è®©ä½¿ç”¨ç‡åœ¨ 70-85% ä¹‹é—´ï¼ˆçœ‹èµ·æ¥ä¸šåŠ¡ç¹å¿™ä½†ä¸æ‹¥æŒ¤ï¼‰### æ¼”ç¤ºæ•°æ®è¦ç‚¹## ğŸ¯ ç­”è¾©æ¼”ç¤ºå»ºè®®é…åˆ---```}  }    "pages": 10            // æ€»é¡µæ•°ï¼ˆå¯é€‰ï¼‰    "page_size": 10,       // æ¯é¡µæ¡æ•°    "page": 1,             // å½“å‰é¡µ    "total": 100,          // æ€»æ¡æ•°    "items": [...],        // å½“å‰é¡µæ•°æ®  "data": {  "message": "ok",  "code": 0,{```json### 3. åˆ†é¡µæ ¼å¼```}  "data": null  "message": "é”™è¯¯æè¿°",  "code": 400/404/500,{// å¤±è´¥}  "data": { ... }  "message": "ok",  "code": 0,{// æˆåŠŸ```json### 2. ç»Ÿä¸€å“åº”æ ¼å¼å‰ç«¯å·²å®šä¹‰å¥½æ‰€æœ‰æ¥å£è·¯å¾„å’Œå‚æ•°ï¼Œåç«¯ç…§ç€å®ç°å³å¯ã€‚å‚è€ƒæ–‡ä»¶: `src/api/bed.js`, `src/api/dashboard.js`### 1. ä½¿ç”¨å‰ç«¯å·²æœ‰çš„æ¥å£å®šä¹‰## ğŸ› ï¸ æ¥å£è°ƒè¯•å»ºè®®---- [ ] å…¬å‘Šè¡¨ï¼ˆnoticesï¼‰æœ‰ 2-3 æ¡æµ‹è¯•æ•°æ®- [ ] è‡³å°‘2ä¸ªç”¨æˆ·ï¼ˆadmin + nurseï¼‰å¯ç”¨äºæ¼”ç¤ºæƒé™- [ ] æŠ¤ç†ä»»åŠ¡åŒ…å« pending/in_progress/completed ä¸‰ç§çŠ¶æ€- [ ] åºŠä½çŠ¶æ€åˆ†å¸ƒåˆç†ï¼ˆ70% occupied, 30% freeï¼‰### å»ºè®®è¡¥å……ï¼ˆæ¼”ç¤ºæ›´æµç•…ï¼‰- [ ] `GET /api/dashboard/stats` è¿”å›æ•°æ®æ—  NaN æˆ– null- [ ] `GET /api/beds/floor-stats` æ¥å£å·²å®ç°å¹¶è¿”å›æ­£ç¡®æ•°æ®- [ ] `care_tasks` è¡¨æœ‰ 5ä¸ªä»Šæ—¥ä»»åŠ¡- [ ] `elderly` è¡¨æœ‰ 3ä¸ª pending + 10ä¸ª in çŠ¶æ€- [ ] æ¯å¼ åºŠä½çš„ `floor` å­—æ®µå·²å¡«å†™ï¼ˆä¸èƒ½ä¸ºç©ºï¼‰- [ ] `beds` è¡¨æœ‰ 30+ æ¡æ•°æ®ï¼Œè‡³å°‘3ä¸ªæ¥¼å±‚### æœ€ä½è¦æ±‚ï¼ˆç­”è¾©æ¼”ç¤ºå¯ç”¨ï¼‰## ğŸ“‹ æ•°æ®å‡†å¤‡æ£€æŸ¥æ¸…å•---```('page.system.users', 'ç”¨æˆ·ç®¡ç†', 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·');('page.care.tasks', 'æŠ¤ç†ä»»åŠ¡', 'ç®¡ç†æŠ¤ç†ä»»åŠ¡'),('page.bed.allocate', 'åºŠä½åˆ†é…', 'åˆ†é…åºŠä½'),('page.bed', 'åºŠä½ç®¡ç†', 'è®¿é—®åºŠä½ç®¡ç†'),('page.elderly.pending', 'ä½æˆ¿å®¡æ‰¹', 'å®¡æ‰¹å…¥ä½ç”³è¯·'),('page.elderly.list', 'è€äººåˆ—è¡¨', 'æŸ¥çœ‹è€äººåˆ—è¡¨'),('page.dashboard', 'é¦–é¡µ', 'è®¿é—®é¦–é¡µ'),INSERT INTO permissions (code, name, description) VALUES```sql**ç¤ºä¾‹**:å‰ç«¯ä½¿ç”¨çš„æƒé™ç æ ¼å¼: `page.æ¨¡å—.åŠŸèƒ½`#### 7.2 æƒé™åˆ—è¡¨ï¼ˆpermissions è¡¨ï¼‰- `receptionist`: å‰å°ï¼ˆè€äººç®¡ç†ã€åºŠä½æŸ¥çœ‹ï¼‰- `nurse`: æŠ¤ç†å‘˜ï¼ˆæŠ¤ç†ç›¸å…³æƒé™ï¼‰- `admin`: ç®¡ç†å‘˜ï¼ˆæ‰€æœ‰æƒé™ï¼‰ç¡®ä¿æ•°æ®åº“ä¸­è‡³å°‘æœ‰ä»¥ä¸‹è§’è‰²ï¼š#### 7.1 è§’è‰²é…ç½®### 7. æƒé™æ•°æ®å‡†å¤‡---```).all()    )        Elderly.id_number.like(f'%{keyword}%')        Elderly.phone.like(f'%{keyword}%'),        Elderly.name.like(f'%{keyword}%'),    or_(results = db.query(Elderly).filter(keyword = request.args.get('keyword')```python**å»ºè®®**: æ”¯æŒæ¨¡ç³Šæœç´¢å¤šä¸ªå­—æ®µ**æ¥å£**: `GET /api/elderly/search?keyword={keyword}`### 6. è€äººæœç´¢æ¥å£ä¼˜åŒ–## ğŸŸ¢ P2 çº§åˆ«ï¼ˆå¯é€‰ï¼Œé”¦ä¸Šæ·»èŠ±ï¼‰---```}  ]    }      "assigned_to_name": "æŠ¤å·¥å°ç‹"      "assigned_to": 10,      "scheduled_time": "2026-01-24T08:00:00",      "priority": "high",      "status": "pending",      "description": "ååŠ©æ´—æ¼±",      "title": "æ™¨é—´æŠ¤ç†",      "elderly_name": "å¼ ä¸‰",      "elderly_id": 5,      "id": 1,    {  "data": [  "message": "ok",  "code": 0,{```json**å“åº”æ ¼å¼**:```).all()    func.date(CareTask.scheduled_time) == todaytasks = db.query(CareTask).filter(today = datetime.now().date()# ç­›é€‰ä»Šæ—¥çš„ä»»åŠ¡ï¼ˆscheduled_time åœ¨ä»Šå¤©ï¼‰```python**å»ºè®®é€»è¾‘**:**å½“å‰é—®é¢˜**: å‰ç«¯éœ€è¦ä»Šæ—¥ä»»åŠ¡ï¼Œåç«¯å¯èƒ½è¿”å›æ‰€æœ‰ä»»åŠ¡**æ¥å£**: `GET /api/care/tasks/today`### 5. ä»Šæ—¥æŠ¤ç†ä»»åŠ¡æ¥å£ä¼˜åŒ–---**æ³¨æ„**: å¦‚æœåºŠä½å·²è¢«å ç”¨ï¼ˆstatus=occupiedï¼‰ï¼Œä¸å…è®¸ä¿®æ”¹ `floor`, `room`, `bed_no` ç­‰æ ¸å¿ƒå­—æ®µ**è¯·æ±‚ä½“**: åŒæ–°å¢ï¼ˆå…è®¸éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼‰**æ¥å£**: `PUT /api/beds/{id}`#### 4.2 æ›´æ–°åºŠä½```}  }    ...    "bed_no": "301-1",    "id": 100,  "data": {  "message": "åºŠä½æ·»åŠ æˆåŠŸ",  "code": 0,{```json**å“åº”**: ```}  "status": "free"  "price": 2000,  "bed_type": "single",  "building": "1å·æ¥¼",  "floor": "3",  "room": "301",  "bed_no": "301-1",{```json**è¯·æ±‚ä½“**:**æ¥å£**: `POST /api/beds`#### 4.1 æ–°å¢åºŠä½### 4. åºŠä½ç®¡ç†æ¥å£å®Œæ•´æ€§---- å„é¡¹ç»Ÿè®¡ä¸æ•°æ®åº“å®é™…æ•°æ®ä¸€è‡´- æ•°å­—è®¡ç®—æ­£ç¡®ï¼ˆä¸è¦å‡ºç° 0/0 å¯¼è‡´ NaNï¼‰**ç¡®ä¿**:```}  }    }      "in_progress": 3    // è¿›è¡Œä¸­      "pending": 10,      // æœªå¼€å§‹      "completed": 15,    // å·²å®Œæˆ      "total": 28,        // ä»Šæ—¥ä»»åŠ¡æ€»æ•°    "todayTasks": {    },      "active": 12        // åœ¨å²—      "total": 15,        // æŠ¤å·¥æ€»æ•°    "caregivers": {    },      "occupancyRate": 78.2  // ä½¿ç”¨ç‡      "free": 12,         // ç©ºé—²      "occupied": 43,     // å·²å ç”¨      "total": 55,        // åºŠä½æ€»æ•°    "beds": {    },      "pending": 3        // å¾…å®¡æ‰¹      "in": 42,           // å·²å…¥ä½      "total": 45,        // è€äººæ€»æ•°    "elderly": {  "data": {  "message": "ok",  "code": 0,{```json**æ£€æŸ¥è¦ç‚¹**:**æ¥å£**: `GET /api/dashboard/stats`### 3. ç¡®ä¿ä»ªè¡¨ç›˜ç»Ÿè®¡æ¥å£æ•°æ®å‡†ç¡®## ğŸŸ¡ P1 çº§åˆ«ï¼ˆå»ºè®®å®Œæˆï¼Œæå‡æ¼”ç¤ºæ•ˆæœï¼‰---```(3, 'é™ªåŒå°±åŒ»', 'çœ¼ç§‘å¤æŸ¥', 'completed', 'medium', '2026-01-24 10:00:00', 10);(2, 'ç”¨è¯æé†’', 'é«˜è¡€å‹è¯ç‰©æœç”¨', 'in_progress', 'high', '2026-01-24 09:00:00', 11),(1, 'æ™¨é—´æŠ¤ç†', 'ååŠ©æ´—æ¼±ã€æ›´è¡£', 'pending', 'high', '2026-01-24 08:00:00', 10),INSERT INTO care_tasks (elderly_id, title, description, status, priority, scheduled_time, assigned_to) VALUES```sql**ç¤ºä¾‹**:- åŒ…å«ä¸åŒçŠ¶æ€ï¼špendingã€in_progressã€completed- 5-8ä¸ªä»Šæ—¥ä»»åŠ¡ï¼ˆscheduled_time ä¸ºä»Šå¤©ï¼‰**æœ€å°‘å‡†å¤‡**: **çŠ¶æ€æµè½¬**: `pending` â†’ `in_progress` â†’ `completed`#### 2.3 æŠ¤ç†ä»»åŠ¡æ•°æ®ï¼ˆcare_tasks è¡¨ï¼‰- `bed_id`: åºŠä½IDï¼ˆå·²å…¥ä½çš„éœ€è¦å…³è”åºŠä½ï¼‰- `admission_date`: å…¥ä½æ—¥æœŸ- `care_level`: æŠ¤ç†ç­‰çº§ï¼ˆ`self_care`, `semi_care`, `full_care`ï¼‰- `status`: çŠ¶æ€- `name`: å§“å**å…³é”®å­—æ®µ**:- 10-15ä¸ª in çŠ¶æ€ï¼ˆæ¼”ç¤ºæŠ¤ç†ä»»åŠ¡ã€åºŠä½åˆ†é…ï¼‰- 3-5ä¸ª pending çŠ¶æ€ï¼ˆæ¼”ç¤ºå®¡æ‰¹ï¼‰**æœ€å°‘å‡†å¤‡**: - `out`: å·²é€€æˆ¿- `in`: å·²å…¥ä½ï¼ˆç”¨äºæ¼”ç¤ºæŠ¤ç†ä»»åŠ¡ï¼‰- `pending`: å¾…å®¡æ‰¹ï¼ˆç”¨äºæ¼”ç¤ºå®¡æ‰¹æµç¨‹ï¼‰**çŠ¶æ€è¯´æ˜**:#### 2.2 è€äººæ•°æ®ï¼ˆelderly è¡¨ï¼‰```-- ç»§ç»­æ·»åŠ æ›´å¤šæ•°æ®...('201-2', '201', '2', '1å·æ¥¼', 'occupied', 'vip', 5000);('201-1', '201', '2', '1å·æ¥¼', 'free', 'single', 2000),('102-1', '102', '1', '1å·æ¥¼', 'occupied', 'double', 3000),('101-2', '101', '1', '1å·æ¥¼', 'free', 'single', 2000),('101-1', '101', '1', '1å·æ¥¼', 'occupied', 'single', 2000),INSERT INTO beds (bed_no, room, floor, building, status, bed_type, price) VALUES```sql**ç¤ºä¾‹SQL**:**æœ€å°‘å‡†å¤‡**: 3ä¸ªæ¥¼å±‚ï¼Œæ¯å±‚è‡³å°‘10å¼ åºŠä½ï¼ˆéƒ¨åˆ†occupiedï¼Œéƒ¨åˆ†freeï¼‰- `price`: ä»·æ ¼ï¼ˆå¦‚ 2000ï¼‰- `bed_type`: åºŠä½ç±»å‹ï¼ˆ`single`, `double`, `vip` ä¹‹ä¸€ï¼‰- `status`: çŠ¶æ€ï¼ˆ`free`, `occupied`, `maintenance`, `locked` ä¹‹ä¸€ï¼‰- `building`: æ¥¼æ ‹ï¼ˆå¦‚ "1å·æ¥¼"ï¼‰- `floor`: æ¥¼å±‚ï¼ˆå¿…é¡»å¡«å†™ï¼Œå¦‚ "1", "2", "3"ï¼‰- `room`: æˆ¿é—´å·ï¼ˆå¦‚ "101", "201"ï¼‰- `bed_no`: åºŠä½ç¼–å·ï¼ˆå¦‚ "101-1", "201-2"ï¼‰**å¿…å¡«å­—æ®µ**:#### 2.1 åºŠä½æ•°æ®ï¼ˆbeds è¡¨ï¼‰### 2. å‡†å¤‡æ¼”ç¤ºæ•°æ®---**å½±å“åŠŸèƒ½**: é¦–é¡µ"å„æ¥¼å±‚åºŠä½ä½¿ç”¨æƒ…å†µ"æ¨¡å—```ORDER BY floor;GROUP BY floorFROM beds    ROUND(SUM(CASE WHEN status = 'occupied' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) as usage_rate    SUM(CASE WHEN status = 'locked' THEN 1 ELSE 0 END) as locked,    SUM(CASE WHEN status = 'maintenance' THEN 1 ELSE 0 END) as maintenance,    SUM(CASE WHEN status = 'free' THEN 1 ELSE 0 END) as free,    SUM(CASE WHEN status = 'occupied' THEN 1 ELSE 0 END) as occupied,    COUNT(*) as total,    floor,SELECT ```sql**SQL å‚è€ƒ**:```}  ]    }      "usage_rate": 90.0      "locked": 0,      "maintenance": 0,      "free": 2,      "occupied": 18,      "total": 20,      "floor": "2",    {    },      "usage_rate": 75.0      "locked": 0,      "maintenance": 0,      "free": 5,      "occupied": 15,      "total": 20,      "floor": "1",    {  "data": [  "message": "ok",  "code": 0,{```json**å“åº”æ ¼å¼**:**è¯·æ±‚**: æ— å‚æ•°**åŠŸèƒ½**: æŒ‰æ¥¼å±‚ç»Ÿè®¡åºŠä½ä½¿ç”¨æƒ…å†µ**æ¥å£**: `GET /api/beds/floor-stats`### 1. å®ç°æ¥¼å±‚åºŠä½ç»Ÿè®¡æ¥å£ â­â­â­## ğŸ”´ P0 çº§åˆ«ï¼ˆç­”è¾©å‰å¿…é¡»å®Œæˆï¼‰---> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§å¿…é¡»å®Œæˆï¼ŒğŸŸ¡ ä¸­ä¼˜å…ˆçº§å»ºè®®å®Œæˆï¼ŒğŸŸ¢ ä½ä¼˜å…ˆçº§å¯é€‰> **ç›®çš„**: é…åˆå‰ç«¯å®Œæˆç­”è¾©æ¼”ç¤ºï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨  > **æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-24      <el-page-header @back="goBack" title="è¿”å›">
      <template #content>
        <span class="page-title">{{ isEdit ? 'ç¼–è¾‘è€äººä¿¡æ¯' : 'æ–°å¢è€äºº' }}</span>
      </template>
    </el-page-header>

    <el-card class="form-card" shadow="never">
      <!-- å¤´åƒä¸Šä¼ éƒ¨åˆ† -->
      <div class="avatar-section">
        <div class="avatar-upload">
          <el-upload
            class="avatar-uploader"
            action="#"
            :auto-upload="false"
            :on-change="handleAvatarChange"
            :show-file-list="false"
          >
            <img v-if="form.avatar" :src="form.avatar" class="avatar-img" />
            <div v-else class="avatar-placeholder">
              <el-icon class="icon"><Plus /></el-icon>
              <span>ä¸Šä¼ å¤´åƒ</span>
            </div>
          </el-upload>
        </div>
        <div class="avatar-info">
          <div class="info-item">
            <span class="label">å¹´é¾„ï¼š</span>
            <span class="value">{{ calculateAge }}</span>
          </div>
          <div class="info-item">
            <span class="label">å…¥ä½æ—¶é•¿ï¼š</span>
            <span class="value">{{ calculateStayDays }}</span>
          </div>
        </div>
      </div>

      <el-divider />

      <el-form
        ref="formRef"
        :model="form"
        :rules="rules"
        label-width="120px"
        size="default"
      >
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <el-divider content-position="left">
          <el-icon><User /></el-icon> åŸºæœ¬ä¿¡æ¯
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="å§“å" prop="name">
              <el-input v-model="form.name" placeholder="è¯·è¾“å…¥è€äººå§“å" />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="æ€§åˆ«" prop="gender">
              <el-radio-group v-model="form.gender">
                <el-radio label="male">ç”·</el-radio>
                <el-radio label="female">å¥³</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="å‡ºç”Ÿæ—¥æœŸ" prop="birthday">
              <el-date-picker
                v-model="form.birthday"
                type="date"
                placeholder="é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="å¹´é¾„">
              <el-input :value="calculateAge" disabled placeholder="è‡ªåŠ¨è®¡ç®—" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="èº«ä»½è¯å·" prop="id_number">
              <el-input v-model="form.id_number" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·" />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="è”ç³»ç”µè¯" prop="phone">
              <el-input v-model="form.phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- æŠ¤ç†ä¿¡æ¯ -->
        <el-divider content-position="left">
          <el-icon><FirstAidKit /></el-icon> æŠ¤ç†ä¿¡æ¯
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="æŠ¤ç†ç­‰çº§" prop="care_level">
              <el-select v-model="form.care_level" placeholder="è¯·é€‰æ‹©æŠ¤ç†ç­‰çº§" style="width: 100%">
                <el-option label="è‡ªç†" value="self_care">
                  <div style="display: flex; align-items: center; justify-content: space-between">
                    <span>è‡ªç†</span>
                    <el-tag type="success" size="small">ç”Ÿæ´»å®Œå…¨è‡ªç†</el-tag>
                  </div>
                </el-option>
                <el-option label="åŠæŠ¤ç†" value="semi_care">
                  <div style="display: flex; align-items: center; justify-content: space-between">
                    <span>åŠæŠ¤ç†</span>
                    <el-tag type="warning" size="small">éœ€éƒ¨åˆ†ååŠ©</el-tag>
                  </div>
                </el-option>
                <el-option label="å…¨æŠ¤ç†" value="full_care">
                  <div style="display: flex; align-items: center; justify-content: space-between">
                    <span>å…¨æŠ¤ç†</span>
                    <el-tag type="danger" size="small">éœ€å…¨é¢ç…§æ–™</el-tag>
                  </div>
                </el-option>
              </el-select>
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="å…¥ä½æ—¥æœŸ" prop="admission_date">
              <el-date-picker
                v-model="form.admission_date"
                type="date"
                placeholder="é€‰æ‹©å…¥ä½æ—¥æœŸ"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="æ—¢å¾€ç—…å²">
              <el-input
                v-model="form.medical_history"
                type="textarea"
                :rows="3"
                placeholder="è¯·è¾“å…¥æ—¢å¾€ç—…å²ï¼Œå¦‚ï¼šé«˜è¡€å‹ã€ç³–å°¿ç—…ç­‰"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="è¿‡æ•ä¿¡æ¯">
              <el-input
                v-model="form.allergies"
                type="textarea"
                :rows="3"
                placeholder="è¯·è¾“å…¥è¿‡æ•ä¿¡æ¯ï¼Œå¦‚ï¼šé’éœ‰ç´ ã€æµ·é²œç­‰"
              />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- ç´§æ€¥è”ç³»äºº -->
        <el-divider content-position="left">
          <el-icon><Phone /></el-icon> ç´§æ€¥è”ç³»äºº
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="è”ç³»äººå§“å" prop="emergency_contact_name">
              <el-input v-model="form.emergency_contact_name" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å" />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="è”ç³»äººç”µè¯" prop="emergency_contact_phone">
              <el-input v-model="form.emergency_contact_phone" placeholder="è¯·è¾“å…¥è”ç³»äººç”µè¯" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ä¸è€äººå…³ç³»">
              <el-input v-model="form.relationship" placeholder="å¦‚ï¼šå­å¥³ã€é…å¶ç­‰" />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- å…¶ä»–ä¿¡æ¯ -->
        <el-divider content-position="left">
          <el-icon><Document /></el-icon> å…¶ä»–ä¿¡æ¯
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item label="å¤‡æ³¨">
              <el-input
                v-model="form.remarks"
                type="textarea"
                :rows="3"
                placeholder="å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯"
              />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- æ“ä½œæŒ‰é’® -->
        <el-form-item>
          <el-button type="primary" @click="handleSubmit" :loading="loading" size="large">
            <el-icon><Check /></el-icon> {{ isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤æ–°å¢' }}
          </el-button>
          <el-button @click="handleReset" size="large">
            <el-icon><RefreshLeft /></el-icon> é‡ç½®
          </el-button>
          <el-button @click="goBack" size="large">
            <el-icon><Close /></el-icon> å–æ¶ˆ
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { User, FirstAidKit, Phone, Document, Check, RefreshLeft, Close, Plus } from '@element-plus/icons-vue'
import { createElderly, updateElderly, getElderlyDetail } from '@/api'
import { formatDate } from '@/utils/format'

const router = useRouter()
const route = useRoute()
const formRef = ref(null)
const loading = ref(false)
const isEdit = ref(false)

// è¡¨å•æ•°æ®
const form = ref({
  avatar: '',
  name: '',
  gender: 'male',
  birthday: '',
  id_number: '',
  phone: '',
  care_level: 'self_care',
  admission_date: '',
  medical_history: '',
  allergies: '',
  emergency_contact_name: '',
  emergency_contact_phone: '',
  relationship: '',
  remarks: ''
})

// è¡¨å•éªŒè¯è§„åˆ™
const rules = {
  name: [
    { required: true, message: 'è¯·è¾“å…¥è€äººå§“å', trigger: 'blur' },
    { min: 2, max: 20, message: 'å§“åé•¿åº¦åœ¨ 2 åˆ° 20 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  gender: [
    { required: true, message: 'è¯·é€‰æ‹©æ€§åˆ«', trigger: 'change' }
  ],
  birthday: [
    { required: true, message: 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ', trigger: 'change' }
  ],
  id_number: [
    { required: true, message: 'è¯·è¾“å…¥èº«ä»½è¯å·', trigger: 'blur' },
    { pattern: /^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/, message: 'è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·', trigger: 'blur' }
  ],
  phone: [
    { required: true, message: 'è¯·è¾“å…¥è”ç³»ç”µè¯', trigger: 'blur' },
    { pattern: /^1[3-9]\d{9}$/, message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', trigger: 'blur' }
  ],
  care_level: [
    { required: true, message: 'è¯·é€‰æ‹©æŠ¤ç†ç­‰çº§', trigger: 'change' }
  ],
  admission_date: [
    { required: true, message: 'è¯·é€‰æ‹©å…¥ä½æ—¥æœŸ', trigger: 'change' }
  ],
  emergency_contact_name: [
    { required: true, message: 'è¯·è¾“å…¥ç´§æ€¥è”ç³»äººå§“å', trigger: 'blur' }
  ],
  emergency_contact_phone: [
    { required: true, message: 'è¯·è¾“å…¥ç´§æ€¥è”ç³»äººç”µè¯', trigger: 'blur' },
    { pattern: /^1[3-9]\d{9}$/, message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', trigger: 'blur' }
  ]
}

// è®¡ç®—å¹´é¾„
const calculateAge = computed(() => {
  if (!form.value.birthday) return '-'
  const birthday = new Date(form.value.birthday)
  const today = new Date()
  let age = today.getFullYear() - birthday.getFullYear()
  const monthDiff = today.getMonth() - birthday.getMonth()
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
    age--
  }
  return age > 0 ? `${age} å²` : '-'
})

// è®¡ç®—å…¥ä½æ—¶é•¿
const calculateStayDays = computed(() => {
  if (!form.value.admission_date) return '-'
  const admission = new Date(form.value.admission_date)
  const today = new Date()
  const diff = today.getTime() - admission.getTime()
  const days = Math.floor(diff / (1000 * 60 * 60 * 24))
  if (days === 0) return 'ä»Šæ—¥å…¥ä½'
  if (days === 1) return '1 å¤©'
  return `${days} å¤©`
})

// å¤´åƒå¤„ç†
const handleAvatarChange = (file) => {
  if (!file.raw) return
  
  // é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ2MBï¼‰
  if (file.raw.size > 2 * 1024 * 1024) {
    ElMessage.error('å¤´åƒå¤§å°ä¸èƒ½è¶…è¿‡ 2MB')
    return
  }
  
  // é™åˆ¶æ–‡ä»¶ç±»å‹
  if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.raw.type)) {
    ElMessage.error('åªæ”¯æŒ JPGã€PNGã€GIF æ ¼å¼çš„å›¾ç‰‡')
    return
  }
  
  // ä½¿ç”¨ FileReader è½¬æ¢ä¸º base64
  const reader = new FileReader()
  reader.onload = (e) => {
    form.value.avatar = e.target.result
  }
  reader.readAsDataURL(file.raw)
}

// è¿”å›
const goBack = () => {
  router.back()
}

// æäº¤è¡¨å•
const handleSubmit = async () => {
  if (!formRef.value) return
  
  await formRef.value.validate(async (valid) => {
    if (valid) {
      loading.value = true
      try {
        if (isEdit.value) {
          await updateElderly(route.params.id, form.value)
          ElMessage.success('è€äººä¿¡æ¯æ›´æ–°æˆåŠŸ')
        } else {
          await createElderly(form.value)
          ElMessage.success('è€äººä¿¡æ¯æ·»åŠ æˆåŠŸ')
        }
        router.push('/home/elderlies/list')
      } catch (error) {
        ElMessage.error(error.response?.data?.detail || 'æ“ä½œå¤±è´¥')
      } finally {
        loading.value = false
      }
    } else {
      ElMessage.warning('è¯·å¡«å†™å®Œæ•´çš„è¡¨å•ä¿¡æ¯')
    }
  })
}

// é‡ç½®è¡¨å•
const handleReset = () => {
  formRef.value?.resetFields()
  // é‡ç½®éè¡¨å•é¡¹å­—æ®µ
  form.value = {
    avatar: '',
    name: '',
    gender: 'male',
    birthday: '',
    id_number: '',
    phone: '',
    care_level: 'self_care',
    admission_date: new Date().toISOString().split('T')[0],
    medical_history: '',
    allergies: '',
    emergency_contact_name: '',
    emergency_contact_phone: '',
    relationship: '',
    remarks: ''
  }
}

// åŠ è½½è€äººè¯¦æƒ…ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
const loadElderlyDetail = async () => {
  try {
    const response = await getElderlyDetail(route.params.id)
    form.value = { ...form.value, ...response.data }
  } catch (error) {
    ElMessage.error('åŠ è½½è€äººä¿¡æ¯å¤±è´¥')
    router.back()
  }
}

onMounted(() => {
  // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
  if (route.params.id) {
    isEdit.value = true
    loadElderlyDetail()
  } else {
    // æ–°å¢æ¨¡å¼ï¼šé»˜è®¤å…¥ä½æ—¥æœŸä¸ºä»Šå¤©
    form.value.admission_date = new Date().toISOString().split('T')[0]
  }
})
</script>

<style scoped>
.elderly-add-page {
  padding: 24px;
  background-color: #f5f7fa;
  min-height: 100%;
}

.page-title {
  font-size: 18px;
  font-weight: 600;
  color: #303133;
}

.form-card {
  margin-top: 20px;
  max-width: 1200px;
}

.avatar-section {
  display: flex;
  align-items: center;
  gap: 40px;
  margin-bottom: 24px;
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
}

.avatar-upload {
  flex-shrink: 0;
}

.avatar-uploader {
  width: 120px;
  height: 120px;
}

:deep(.avatar-uploader .el-upload) {
  border: 2px dashed #409eff;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
}

:deep(.avatar-uploader .el-upload:hover) {
  border-color: #66b1ff;
  background-color: #f5f7fa;
}

.avatar-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 120px;
  height: 120px;
  color: #909399;
  font-size: 14px;
}

.avatar-placeholder .icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.avatar-img {
  width: 120px;
  height: 120px;
  display: block;
  border-radius: 6px;
  object-fit: cover;
}

.avatar-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.info-item {
  display: flex;
  align-items: center;
  font-size: 14px;
}

.info-item .label {
  color: #606266;
  min-width: 60px;
}

.info-item .value {
  color: #303133;
  font-weight: 600;
}

:deep(.el-divider) {
  margin: 32px 0 24px;
}

:deep(.el-divider__text) {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #409eff;
}

:deep(.el-form-item) {
  margin-bottom: 24px;
}

:deep(.el-form-item__label) {
  font-weight: 500;
}

.el-button + .el-button {
  margin-left: 12px;
}
</style>